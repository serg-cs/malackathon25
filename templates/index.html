<!doctype html>
<html lang="es" data-bs-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#99BBFF" />
        <title>Base Datos Salud Mental</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />
        <link rel="stylesheet" href="/static/styles.css" />
        <script
            src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
        <style>
            body {
                transition:
                    background-color 0.3s,
                    color 0.3s;
                min-height: 100vh;
                padding-top: 56px;
            }
            [data-bs-theme="dark"] body {
                color: #f8f9fa;
                background-color: #212529;
            }
            .chart-container {
                width: 100%;
                min-height: 400px;
                margin-bottom: 2rem;
                border: 1px solid var(--bs-border-color);
                border-radius: 0.375rem;
                padding: 1.25rem;
                background-color: var(--bs-body-bg);
                color: var(--bs-body-color);
                box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            .chart-body {
                height: 320px;
                overflow: hidden;
                position: relative;
                flex: 0 0 auto;
            }
            .chart-container h5 {
                font-weight: 600;
            }
            .chart-container p {
                color: var(--bs-secondary-color);
                margin-bottom: 1rem;
            }
            /* Round buttons */
            .btn-round {
                width: 42px;
                height: 42px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                font-size: 1.25rem;
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                line-height: 1;
            }
            .btn-round .bi {
                vertical-align: middle;
            }
            [data-bs-theme="light"] .btn-round {
                background-color: #f8f9fa;
                border: 1px solid #ced4da;
                color: #0d6efd;
            }
            [data-bs-theme="light"] .btn-round:hover {
                background-color: #e9ecef;
                border-color: #adb5bd;
                color: #0b5ed7;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            }
            [data-bs-theme="dark"] .btn-round {
                background-color: #2b3035;
                border: 1px solid #495057;
                color: #f8f9fa;
            }
            [data-bs-theme="dark"] .btn-round:hover {
                background-color: #343a40;
                border-color: #6c757d;
                color: #0dcaf0;
                box-shadow: 0 3px 6px rgba(255, 255, 255, 0.2);
            }
            .navbar-brand img {
                height: 38px;
                border-radius: 8px;
                object-fit: cover;
            }
            .kpi-card {
                border: none;
                border-radius: 0.75rem;
                background-color: var(--bs-card-bg);
                color: var(--bs-body-color);
                box-shadow: 0 12px 24px rgba(15, 23, 42, 0.1);
            }
            .kpi-card .card-body {
                padding: 1.5rem;
            }
            .chart-legend {
                display: flex;
                flex-wrap: wrap;
                gap: 0.75rem;
                justify-content: center;
                padding: 0.75rem 0 0;
                margin-top: 1rem;
                border-top: 1px solid var(--bs-border-color);
                flex: 0 0 auto;
            }
            .chart-legend .legend-item {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.45rem 0.85rem;
                border-radius: 999px;
                border: 1px solid var(--bs-border-color);
                background-color: var(--bs-body-bg);
                color: inherit;
                font-size: 0.85rem;
                line-height: 1;
                cursor: pointer;
                transition: transform 0.12s ease, opacity 0.18s ease,
                    background-color 0.18s ease, border-color 0.18s ease;
            }
            .chart-legend .legend-item:hover {
                transform: translateY(-1px);
                background-color: rgba(148, 163, 184, 0.12);
            }
            .chart-legend .legend-item.inactive {
                opacity: 0.55;
                text-decoration: line-through;
            }
            .chart-legend .legend-item:focus-visible {
                outline: 2px solid rgba(37, 99, 235, 0.6);
                outline-offset: 2px;
            }
            .chart-legend .legend-item .legend-swatch {
                width: 12px;
                height: 12px;
                border-radius: 4px;
                flex-shrink: 0;
            }
        </style>
    </head>
    <body class="d-flex flex-column">
        <nav
            class="navbar navbar-expand-lg bg-body-tertiary px-3 shadow-sm fixed-top"
        >
            <a class="navbar-brand" href="#">
                <img src="static/image.png" alt="Logo" />
            </a>
            <div class="ms-auto d-flex align-items-center">
                <!-- Help Button -->
                <button
                    class="btn btn-round me-2"
                    data-bs-toggle="modal"
                    data-bs-target="#instructionsModal"
                >
                    <i class="bi bi-question-circle"></i>
                </button>
                <!-- Settings Button -->
                <div class="dropdown">
                    <button
                        class="btn btn-round"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                    >
                        <i class="bi bi-gear"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button class="dropdown-item" id="themeToggle">
                                <i class="bi bi-moon-stars me-2"></i> Cambiar
                                Tema Claro/Oscuro
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Modal -->
        <div
            class="modal fade"
            id="instructionsModal"
            tabindex="-1"
            aria-labelledby="instructionsModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="instructionsModalLabel">
                            <i class="bi bi-info-circle me-2"></i>Instrucciones
                            de Uso
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            En esta página puedes observar gráficamente los
                            distintos datos sobre salud mental en España.
                            También puedes cambiar el tema de la página pulsado
                            el botón de configuración de la derecha. Puedes
                            interaccionar con las leyendas de las gráficas para
                            poder observar los datos más específicos.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                        >
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <main class="flex-grow-1">
            <div
                id="main-body"
                class="container justify-content-center pt-4"
                data-dashboard="{{ data | json }}"
            >
                <h2 class="mb-4 text-center text-lg-start text-body-emphasis">
                    Panel visual de explotación clínica
                </h2>
                <p class="text-body text-center text-lg-start mb-5">
                    Analiza la evolución temporal de ingresos, los diagnósticos
                    y procedimientos más frecuentes, la distribución de costes y
                    los perfiles de estancia hospitalaria. Ajusta el tema visual
                    según tus preferencias desde el menú de configuración.
                </p>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-lg-4">
                        <div class="card kpi-card h-100">
                            <div class="card-body">
                                <span
                                    class="text-body-secondary text-uppercase small fw-semibold"
                                    >Atenciones totales</span
                                >
                                <h3
                                    class="fw-bold mb-0 text-body-emphasis"
                                    id="metric-total-encounters"
                                >
                                    —
                                </h3>
                                <p class="mt-2 mb-0 text-body-secondary">
                                    Conteo agregado de episodios registrados.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4">
                        <div class="card kpi-card h-100">
                            <div class="card-body">
                                <span
                                    class="text-body-secondary text-uppercase small fw-semibold"
                                    >Coste acumulado</span
                                >
                                <h3
                                    class="fw-bold mb-0 text-body-emphasis"
                                    id="metric-total-cost"
                                >
                                    —
                                </h3>
                                <p class="mt-2 mb-0 text-body-secondary">
                                    Suma estimada del gasto por régimen de
                                    financiación.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4">
                        <div class="card kpi-card h-100">
                            <div class="card-body">
                                <span
                                    class="text-body-secondary text-uppercase small fw-semibold"
                                    >Diagnósticos monitorizados</span
                                >
                                <h3
                                    class="fw-bold mb-0 text-body-emphasis"
                                    id="metric-diagnosis-count"
                                >
                                    —
                                </h3>
                                <p class="mt-2 mb-0 text-body-secondary">
                                    Número de diagnósticos únicos incluidos en
                                    el análisis.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chartsContainer" class="row gy-4">
                    <!-- Charts render here -->
                </div>
            </div>
        </main>
        <footer
            class="footer mt-auto py-3 bg-body-tertiary border-top flex-shrink-0"
        >
            <div class="container text-center">
                <span class="text-body-secondary">
                    Proyecto <strong>#Malackathon2025</strong> de los Chocobons.
                </span>
            </div>
        </footer>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            const htmlElement = document.documentElement;
            const toggleBtn = document.getElementById("themeToggle");
            const savedTheme = localStorage.getItem("theme") || "light";
            htmlElement.setAttribute("data-bs-theme", savedTheme);

            const chartsContainer = document.getElementById("chartsContainer");
            const totalEncountersEl = document.getElementById(
                "metric-total-encounters",
            );
            const totalCostEl = document.getElementById("metric-total-cost");
            const diagnosisCountEl = document.getElementById(
                "metric-diagnosis-count",
            );
            const rootElement = document.getElementById("main-body");

            const toArray = (value) => (Array.isArray(value) ? value : []);
            const sum = (arr) =>
                arr.reduce((acc, value) => acc + (Number(value) || 0), 0);
            const formatCurrency = (value) =>
                new Intl.NumberFormat("es-ES", {
                    style: "currency",
                    currency: "EUR",
                    maximumFractionDigits: 0,
                }).format(value ?? 0);
            const formatInteger = (value) =>
                new Intl.NumberFormat("es-ES").format(Math.round(value ?? 0));
            const shortenLabel = (label, maxLength = 18) => {
                const text =
                    typeof label === "string" ? label : String(label ?? "");
                return text.length > maxLength
                    ? `${text.slice(0, maxLength).trimEnd()}…`
                    : text;
            };
            const wrapLabel = (label, maxLineLength = 18, maxLines = 3) => {
                const text =
                    typeof label === "string" ? label : String(label ?? "");
                const words = text.split(/\s+/);
                const lines = [];
                let current = "";

                for (const word of words) {
                    const candidate = current ? `${current} ${word}` : word;

                    if (candidate.length > maxLineLength) {
                        if (current) {
                            lines.push(current);
                            if (lines.length === maxLines) {
                                lines[maxLines - 1] = shortenLabel(
                                    lines[maxLines - 1],
                                    maxLineLength,
                                );
                                return lines.join("\n");
                            }
                            current =
                                word.length > maxLineLength
                                    ? shortenLabel(word, maxLineLength)
                                    : word;
                        } else {
                            lines.push(
                                word.length > maxLineLength
                                    ? shortenLabel(word, maxLineLength)
                                    : word,
                            );
                            if (lines.length === maxLines) {
                                return lines.join("\n");
                            }
                            current = "";
                        }
                    } else {
                        current = candidate;
                    }
                }

                if (current) {
                    if (lines.length === maxLines) {
                        lines[maxLines - 1] = shortenLabel(
                            current,
                            maxLineLength,
                        );
                    } else {
                        lines.push(current);
                    }
                }

                return lines.slice(0, maxLines).join("\n");
            };
            const getChartTextColor = () => {
                const theme = htmlElement.getAttribute("data-bs-theme");
                return theme === "dark" ? "#F8F9FA" : "#212529";
            };

            let payload = {};
            try {
                payload = JSON.parse(rootElement?.dataset.dashboard ?? "{}");
            } catch (error) {
                console.error(
                    "No se pudo interpretar el JSON de estadísticas",
                    error,
                );
                chartsContainer.innerHTML =
                    '<div class="col-12"><div class="alert alert-danger">Error cargando los datos del panel.</div></div>';
                payload = {};
            }

            const timelineEntries = toArray(payload.atencionesPorFecha);
            const timelineTrimmed = timelineEntries.slice(-180);
            const timelineLabels = timelineTrimmed.map((entry) => entry.fecha);
            const timelineValues = timelineTrimmed.map(
                (entry) => Number(entry.total) || 0,
            );
            const totalEncounters = sum(
                timelineEntries.map((entry) => Number(entry.total) || 0),
            );

            if (totalEncountersEl) {
                totalEncountersEl.textContent =
                    timelineEntries.length > 0
                        ? formatInteger(totalEncounters)
                        : "—";
            }

            const regimenEntries = toArray(payload.costePorRegimen);
            const regimenLabels = regimenEntries.map(
                (entry) => entry.regimenFinanciacion ?? "Sin identificar",
            );
            const regimenValues = regimenEntries.map(
                (entry) => Number(entry.costeTotal) || 0,
            );
            const regimenAverage =
                regimenValues.length > 0
                    ? regimenValues.reduce((acc, value) => acc + value, 0) /
                      regimenValues.length
                    : null;
            const totalCost = sum(regimenValues);

            if (totalCostEl) {
                totalCostEl.textContent =
                    regimenValues.length > 0 ? formatCurrency(totalCost) : "—";
            }

            const diagnosisList = toArray(payload.diagnosticosComunes);
            const topDiagnosis = diagnosisList.slice(0, 10);
            const diagnosisLabels = topDiagnosis.map(
                (entry) => entry.nombre ?? entry.codigo ?? "Sin nombre",
            );
            const diagnosisValues = topDiagnosis.map(
                (entry) => Number(entry.total) || 0,
            );

            if (diagnosisCountEl) {
                diagnosisCountEl.textContent = diagnosisList.length
                    ? formatInteger(diagnosisList.length)
                    : "—";
            }

            const procedureEntries = toArray(payload.procedimientosComunes);
            const topProcedures = procedureEntries.slice(0, 10);
            const procedureLabels = topProcedures.map(
                (entry) => entry.nombre ?? entry.codigo ?? "Sin nombre",
            );
            const procedureValues = topProcedures.map(
                (entry) => Number(entry.total) || 0,
            );
            const procedureAverage =
                procedureValues.length > 0
                    ? procedureValues.reduce((acc, value) => acc + value, 0) /
                      procedureValues.length
                    : null;

            const stayGroups = toArray(payload.estanciasPorSexo);
            const stayTotals = new Map();
            stayGroups.forEach((group) => {
                toArray(group.distribucion).forEach(({ dias, total }) => {
                    const day = Number(dias);
                    if (!Number.isNaN(day)) {
                        stayTotals.set(
                            day,
                            (stayTotals.get(day) || 0) + (Number(total) || 0),
                        );
                    }
                });
            });
            let stayDays = Array.from(stayTotals.keys()).sort((a, b) => a - b);
            let stayValues = stayDays.map((day) => stayTotals.get(day) || 0);
            const stayLimit = 120;
            if (stayDays.length > stayLimit) {
                stayDays = stayDays.slice(0, stayLimit);
                stayValues = stayValues.slice(0, stayLimit);
            }

            const stayBySexAxisSet = new Set();
            stayGroups.forEach((group) => {
                toArray(group.distribucion).forEach(({ dias }) => {
                    const day = Number(dias);
                    if (!Number.isNaN(day)) {
                        stayBySexAxisSet.add(day);
                    }
                });
            });
            let stayBySexAxis = Array.from(stayBySexAxisSet).sort(
                (a, b) => a - b,
            );
            if (stayBySexAxis.length > stayLimit) {
                stayBySexAxis = stayBySexAxis.slice(0, stayLimit);
            }
            const stayBySexSeries = stayGroups.map((group) => {
                const valuesByDay = new Map(
                    toArray(group.distribucion).map(({ dias, total }) => [
                        Number(dias),
                        Number(total) || 0,
                    ]),
                );
                return {
                    name: group.sexo ?? "Sin especificar",
                    type: "line",
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 3 },
                    data: stayBySexAxis.map((day) => valuesByDay.get(day) || 0),
                };
            });

            const dischargeTotals = new Map();
            toArray(payload.tipoAltaPorSeveridad).forEach((entry) => {
                const label = entry.tipoAlta ?? "Sin dato";
                dischargeTotals.set(
                    label,
                    (dischargeTotals.get(label) || 0) +
                        (Number(entry.total) || 0),
                );
            });
            const dischargeData = Array.from(dischargeTotals.entries()).map(
                ([name, value]) => ({
                    name,
                    value,
                }),
            );

            const basePalette = [
                "#5470C6",
                "#91CC75",
                "#FAC858",
                "#EE6666",
                "#73C0DE",
                "#3BA272",
                "#FC8452",
                "#9A60B4",
                "#EA7CCC",
            ];
            const pickSeriesColors = (count) =>
                Array.from({ length: count }, (_, index) =>
                    basePalette[index % basePalette.length],
                );

            function mountSelectableLegend({
                chart,
                container,
                labels,
                values,
                colors,
            }) {
                const selected = labels.map(() => true);

                container.setAttribute("role", "group");
                container.setAttribute(
                    "aria-label",
                    "Leyenda interactiva de categorías",
                );

                const applySelection = () => {
                    const data = values.map((value, index) => ({
                        name: labels[index],
                        value: selected[index] ? value : null,
                    }));
                    chart.setOption({ series: [{ data }] });
                };

                const renderLegend = () => {
                    container.innerHTML = "";
                    labels.forEach((label, index) => {
                        const palette =
                            colors && colors.length
                                ? colors
                                : basePalette;
                        const swatchColor =
                            palette[index % palette.length];
                        const item = document.createElement("button");
                        item.type = "button";
                        item.className = `legend-item${
                            selected[index] ? "" : " inactive"
                        }`;
                        item.setAttribute(
                            "aria-pressed",
                            selected[index] ? "true" : "false",
                        );
                        item.innerHTML = `<span class="legend-swatch" style="background:${swatchColor}"></span><span>${label}</span>`;

                        item.addEventListener("click", () => {
                            selected[index] = !selected[index];
                            applySelection();
                            renderLegend();
                        });
                        item.addEventListener("mouseenter", () => {
                            chart.dispatchAction({
                                type: "highlight",
                                seriesIndex: 0,
                                dataIndex: index,
                            });
                        });
                        item.addEventListener("mouseleave", () => {
                            chart.dispatchAction({
                                type: "downplay",
                                seriesIndex: 0,
                                dataIndex: index,
                            });
                        });

                        container.appendChild(item);
                    });
                };

                applySelection();
                renderLegend();
            }

            const chartsConfig = [
                {
                    title: "Diagnósticos con mayor volumen",
                    description:
                        "Diez diagnósticos principales ordenados por número de atenciones.",
                    colClass: "col-12 col-lg-6",
                    palette: pickSeriesColors(diagnosisValues.length || 0),
                    xLabelMaxLength: 16,
                    xLabelMaxLines: 3,
                    data: { labels: diagnosisLabels, values: diagnosisValues },
                    isEmpty: (data) =>
                        !data ||
                        !Array.isArray(data.labels) ||
                        data.labels.length === 0,
                    getOption: (data, textColor, ctx) => ({
                        tooltip: {
                            trigger: "axis",
                            axisPointer: { type: "shadow" },
                        },
                        grid: {
                            left: "4%",
                            right: "4%",
                            bottom: "14%",
                            containLabel: true,
                        },
                        xAxis: {
                            type: "category",
                            data: data.labels,
                            axisLabel: {
                                show: false,
                            },
                            axisTick: { show: false },
                            axisLine: { show: false },
                        },
                        yAxis: {
                            type: "value",
                            name: "Pacientes",
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            splitLine: {
                                lineStyle: {
                                    color: "rgba(148,163,184,0.3)",
                                    type: "dashed",
                                },
                            },
                        },
                        series: [
                            {
                                type: "bar",
                                data: data.labels.map((label, index) => ({
                                    name: label,
                                    value: data.values[index],
                                })),
                                barMaxWidth: 48,
                                itemStyle: {
                                    borderRadius: [8, 8, 0, 0],
                                    color: (params) => {
                                        const palette =
                                            ctx?.palette?.length
                                                ? ctx.palette
                                                : basePalette;
                                        return palette[
                                            params.dataIndex % palette.length
                                        ];
                                    },
                                },
                            },
                        ],
                    }),
                    buildLegend(chart, container) {
                        const colors = this.palette.length
                            ? this.palette
                            : pickSeriesColors(this.data.labels.length);
                        mountSelectableLegend({
                            chart,
                            container,
                            labels: this.data.labels,
                            values: this.data.values,
                            colors,
                        });
                    },
                },
                {
                    title: "Distribución global de estancias",
                    description:
                        "Pacientes acumulados por duración de ingreso hospitalario.",
                    colClass: "col-12 col-lg-6",
                    data: { labels: stayDays, values: stayValues },
                    isEmpty: (data) =>
                        !data ||
                        !Array.isArray(data.labels) ||
                        data.labels.length === 0,
                    getOption: (data, textColor) => ({
                        tooltip: { trigger: "axis" },
                        grid: {
                            left: "4%",
                            right: "4%",
                            bottom: "12%",
                            containLabel: true,
                        },
                        xAxis: {
                            type: "category",
                            name: "Días de estancia",
                            data: data.labels,
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            boundaryGap: false,
                        },
                        yAxis: {
                            type: "value",
                            name: "Pacientes",
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            splitLine: {
                                lineStyle: {
                                    color: "rgba(148,163,184,0.3)",
                                    type: "dashed",
                                },
                            },
                        },
                        series: [
                            {
                                type: "line",
                                smooth: true,
                                symbol: "circle",
                                symbolSize: 6,
                                lineStyle: { width: 3, color: "#0ea5e9" },
                                itemStyle: { color: "#2563eb" },
                                data: data.values,
                                areaStyle: {
                                    opacity: 0.2,
                                    color: new echarts.graphic.LinearGradient(
                                        0,
                                        0,
                                        0,
                                        1,
                                        [
                                            {
                                                offset: 0,
                                                color: "rgba(14,165,233,0.35)",
                                            },
                                            {
                                                offset: 1,
                                                color: "rgba(14,165,233,0.05)",
                                            },
                                        ],
                                    ),
                                },
                            },
                        ],
                    }),
                },
                {
                    title: "Coste por régimen de financiación",
                    description:
                        "Comparativa del gasto total agrupado por régimen financiero.",
                    colClass: "col-12 col-lg-6",
                    palette: pickSeriesColors(regimenLabels.length || 0),
                    xLabelMaxLength: 24,
                    xLabelMaxLines: 3,
                    xLabelMaxLines: 3,
                    data: {
                        labels: regimenLabels,
                        values: regimenValues,
                        average: regimenAverage,
                    },
                    isEmpty: (data) =>
                        !data ||
                        !Array.isArray(data.labels) ||
                        data.labels.length === 0,
                    getOption: (data, textColor, ctx) => {
                        const palette =
                            ctx?.palette?.length > 0
                                ? ctx.palette
                                : basePalette;
                        const series = {
                            type: "bar",
                            data: data.labels.map((label, index) => ({
                                name: label,
                                value: data.values[index],
                            })),
                            barMaxWidth: 48,
                            itemStyle: {
                                borderRadius: [8, 8, 0, 0],
                                color: (params) =>
                                    palette[
                                        params.dataIndex % palette.length
                                    ],
                            },
                        };

                        if (data.average != null) {
                            series.markLine = {
                                symbol: "none",
                                data: [
                                    {
                                        yAxis: data.average,
                                        lineStyle: {
                                            color: "#f97316",
                                            width: 2,
                                        },
                                        label: {
                                            formatter: `Media: ${formatCurrency(data.average)}`,
                                            color: "#f97316",
                                            backgroundColor:
                                                "rgba(249,115,22,0.1)",
                                            borderRadius: 6,
                                            padding: [4, 8],
                                            position: "insideStartTop",
                                            align: "left",
                                            distance: 12,
                                        },
                                    },
                                ],
                            };
                        }

                        return {
                            tooltip: {
                                trigger: "axis",
                                axisPointer: { type: "shadow" },
                                valueFormatter: (value) =>
                                    formatCurrency(value),
                            },
                            grid: {
                                left: "4%",
                                right: "4%",
                                bottom: "16%",
                                containLabel: true,
                            },
                            xAxis: {
                                type: "category",
                                data: data.labels,
                                axisLabel: {
                                    show: false,
                                },
                                axisTick: { show: false },
                                axisLine: { show: false },
                            },
                            yAxis: {
                                type: "value",
                                name: "Coste total (€)",
                                axisLabel: { color: textColor },
                                axisLine: { lineStyle: { color: textColor } },
                                splitLine: {
                                    lineStyle: {
                                        color: "rgba(148,163,184,0.3)",
                                        type: "dashed",
                                    },
                                },
                            },
                            series: [series],
                        };
                    },
                    buildLegend(chart, container) {
                        const colors = this.palette.length
                            ? this.palette
                            : pickSeriesColors(this.data.labels.length);
                        mountSelectableLegend({
                            chart,
                            container,
                            labels: this.data.labels,
                            values: this.data.values,
                            colors,
                        });
                    },
                },
                {
                    title: "Procedimientos más demandados",
                    description:
                        "Ranking de intervenciones con mayor número de registros.",
                    colClass: "col-12 col-lg-6",
                    palette: pickSeriesColors(procedureLabels.length || 0),
                    xLabelMaxLength: 24,
                    data: {
                        labels: procedureLabels,
                        values: procedureValues,
                        average: procedureAverage,
                    },
                    isEmpty: (data) =>
                        !data ||
                        !Array.isArray(data.labels) ||
                        data.labels.length === 0,
                    getOption: (data, textColor, ctx) => {
                        const palette =
                            ctx?.palette?.length > 0
                                ? ctx.palette
                                : basePalette;
                        const series = {
                            type: "bar",
                            data: data.labels.map((label, index) => ({
                                name: label,
                                value: data.values[index],
                            })),
                            barMaxWidth: 48,
                            itemStyle: {
                                borderRadius: [8, 8, 0, 0],
                                color: (params) =>
                                    palette[
                                        params.dataIndex % palette.length
                                    ],
                            },
                        };

                        if (data.average != null) {
                            series.markLine = {
                                symbol: "none",
                                data: [
                                    {
                                        yAxis: data.average,
                                        lineStyle: {
                                            color: "#f97316",
                                            width: 2,
                                        },
                                        label: {
                                            formatter: `Media: ${formatInteger(data.average)}`,
                                            color: "#f97316",
                                            backgroundColor:
                                                "rgba(249,115,22,0.1)",
                                            borderRadius: 6,
                                            padding: [4, 8],
                                            position: "insideStartTop",
                                            align: "left",
                                            distance: 12,
                                        },
                                    },
                                ],
                            };
                        }

                        return {
                            tooltip: {
                                trigger: "axis",
                                axisPointer: { type: "shadow" },
                                valueFormatter: (value) => formatInteger(value),
                            },
                            grid: {
                                left: "4%",
                                right: "4%",
                                bottom: "16%",
                                containLabel: true,
                            },
                            xAxis: {
                                type: "category",
                                data: data.labels,
                                axisLabel: {
                                    show: false,
                                },
                                axisTick: { show: false },
                                axisLine: { show: false },
                            },
                            yAxis: {
                                type: "value",
                                name: "Procedimientos",
                                axisLabel: { color: textColor },
                                axisLine: { lineStyle: { color: textColor } },
                                splitLine: {
                                    lineStyle: {
                                        color: "rgba(148,163,184,0.3)",
                                        type: "dashed",
                                    },
                                },
                            },
                            series: [series],
                        };
                    },
                    buildLegend(chart, container) {
                        const colors = this.palette.length
                            ? this.palette
                            : pickSeriesColors(this.data.labels.length);
                        mountSelectableLegend({
                            chart,
                            container,
                            labels: this.data.labels,
                            values: this.data.values,
                            colors,
                        });
                    },
                },
                {
                    title: "Atenciones por día",
                    description:
                        "Evolución temporal de la actividad asistencial (últimos 180 días).",
                    colClass: "col-12",
                    data: { labels: timelineLabels, values: timelineValues },
                    isEmpty: (data) =>
                        !data ||
                        !Array.isArray(data.labels) ||
                        data.labels.length === 0,
                    getOption: (data, textColor) => ({
                        tooltip: { trigger: "axis" },
                        grid: {
                            left: "3%",
                            right: "3%",
                            bottom: "10%",
                            containLabel: true,
                        },
                        xAxis: {
                            type: "category",
                            data: data.labels,
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            boundaryGap: false,
                        },
                        yAxis: {
                            type: "value",
                            name: "Atenciones",
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            splitLine: {
                                lineStyle: {
                                    color: "rgba(148,163,184,0.25)",
                                    type: "dashed",
                                },
                            },
                        },
                        series: [
                            {
                                type: "line",
                                smooth: true,
                                symbol: "none",
                                lineStyle: { width: 2.8, color: "#2563eb" },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(
                                        0,
                                        0,
                                        0,
                                        1,
                                        [
                                            {
                                                offset: 0,
                                                color: "rgba(37,99,235,0.32)",
                                            },
                                            {
                                                offset: 1,
                                                color: "rgba(37,99,235,0.02)",
                                            },
                                        ],
                                    ),
                                },
                                data: data.values,
                            },
                        ],
                    }),
                },
                {
                    title: "Perfil de estancias por sexo",
                    description:
                        "Comparativa del volumen de pacientes por duración y sexo.",
                    colClass: "col-12 col-xl-7",
                    data: { axis: stayBySexAxis, series: stayBySexSeries },
                    isEmpty: (data) =>
                        !data ||
                        !Array.isArray(data.axis) ||
                        data.axis.length === 0 ||
                        !Array.isArray(data.series) ||
                        data.series.length === 0,
                    getOption: (data, textColor) => ({
                        tooltip: { trigger: "axis" },
                        legend: {
                            top: 10,
                            textStyle: { color: textColor },
                        },
                        grid: {
                            left: "4%",
                            right: "2%",
                            bottom: "10%",
                            containLabel: true,
                        },
                        xAxis: {
                            type: "category",
                            name: "Días de estancia",
                            data: data.axis,
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            boundaryGap: false,
                        },
                        yAxis: {
                            type: "value",
                            name: "Pacientes",
                            axisLabel: { color: textColor },
                            axisLine: { lineStyle: { color: textColor } },
                            splitLine: {
                                lineStyle: {
                                    color: "rgba(148,163,184,0.3)",
                                    type: "dashed",
                                },
                            },
                        },
                        series: data.series.map((series, index) => ({
                            ...series,
                            lineStyle: {
                                ...series.lineStyle,
                                color: ["#2563eb", "#0ea5e9", "#f97316"][
                                    index % 3
                                ],
                            },
                        })),
                    }),
                },
                {
                    title: "Tipo de alta por severidad",
                    description:
                        "Distribución agregada por modalidad de alta hospitalaria.",
                    colClass: "col-12 col-xl-5",
                    data: dischargeData,
                    isEmpty: (data) =>
                        !Array.isArray(data) || data.length === 0,
                    getOption: (data, textColor) => ({
                        tooltip: {
                            trigger: "item",
                            valueFormatter: (value) => formatInteger(value),
                        },
                        legend: {
                            bottom: 0,
                            type: "scroll",
                            textStyle: { color: textColor },
                        },
                        series: [
                            {
                                name: "Altas",
                                type: "pie",
                                radius: ["35%", "70%"],
                                center: ["50%", "42%"],
                                avoidLabelOverlap: true,
                                label: {
                                    formatter:
                                        "{b|{b}}\n{hr|}\n{c} pacientes ({d}%)",
                                    rich: {
                                        b: {
                                            fontWeight: 600,
                                            color: textColor,
                                        },
                                        hr: {
                                            backgroundColor: "#cbd5f5",
                                            height: 1,
                                            width: "100%",
                                            lineHeight: 10,
                                        },
                                    },
                                },
                                labelLine: {
                                    smooth: true,
                                    length: 10,
                                    length2: 18,
                                },
                                data,
                            },
                        ],
                    }),
                },
            ];

            let chartInstances = [];

            function drawAllCharts() {
                chartsContainer.innerHTML = "";
                chartInstances.forEach((instance) => instance?.dispose?.());
                chartInstances = [];

                const textColor = getChartTextColor();
                const echartsTheme =
                    htmlElement.getAttribute("data-bs-theme") === "dark"
                        ? "dark"
                        : null;

                chartsConfig.forEach((chartInfo, index) => {
                    const col = document.createElement("div");
                    col.className = `${
                        chartInfo.colClass ?? "col-12"
                    } d-flex flex-column`;

                    const container = document.createElement("div");
                    container.className =
                        "chart-container flex-fill d-flex flex-column";

                    const header = document.createElement("div");
                    header.className = "chart-header mb-3";
                    const titleEl = document.createElement("h5");
                    titleEl.className = "mb-1 text-body-emphasis";
                    titleEl.textContent = chartInfo.title;
                    const descriptionEl = document.createElement("p");
                    descriptionEl.className = "mb-0 text-body-secondary";
                    descriptionEl.textContent = chartInfo.description ?? "";
                    header.appendChild(titleEl);
                    header.appendChild(descriptionEl);
                    container.appendChild(header);

                    if (chartInfo.isEmpty(chartInfo.data)) {
                        const emptyState = document.createElement("div");
                        emptyState.className =
                            "d-flex align-items-center justify-content-center text-body-secondary";
                        emptyState.style.height = "260px";
                        emptyState.textContent =
                            "No hay datos suficientes para mostrar esta gráfica.";
                        container.appendChild(emptyState);
                        col.appendChild(container);
                        chartsContainer.appendChild(col);
                        return;
                    }

                    const chartCanvas = document.createElement("div");
                    chartCanvas.className = "chart-body";
                    container.appendChild(chartCanvas);

                    col.appendChild(container);
                    chartsContainer.appendChild(col);

                    const chart = echarts.init(chartCanvas, echartsTheme);
                    chart.setOption(
                        chartInfo.getOption(
                            chartInfo.data,
                            textColor,
                            chartInfo,
                        ),
                    );
                    if (typeof chartInfo.buildLegend === "function") {
                        const legendHost = document.createElement("div");
                        legendHost.className = "chart-legend";
                        container.appendChild(legendHost);
                        chartInfo.buildLegend(chart, legendHost);
                    }
                    chartInstances.push(chart);
                });
            }

            drawAllCharts();

            window.addEventListener("resize", () => {
                chartInstances.forEach((chart) => chart.resize());
            });

            if (toggleBtn) {
                toggleBtn.addEventListener("click", () => {
                    const current = htmlElement.getAttribute("data-bs-theme");
                    const newTheme = current === "light" ? "dark" : "light";
                    htmlElement.setAttribute("data-bs-theme", newTheme);
                    localStorage.setItem("theme", newTheme);
                    setTimeout(drawAllCharts, 100);
                });
            }
        </script>
    </body>
</html>
